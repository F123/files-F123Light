#!/bin/bash
#
# Copyright 2018, F123 Consulting, <information@f123.org>
# Copyright 2018, Kyle, <kyle@free2.ml>
#
# This is free software; you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free
# Software Foundation; either version 3, or (at your option) any later
# version.
#
# This software is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this package; see the file COPYING.  If not, write to the Free
# Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
# 02110-1301, USA.
#
#--code--

# the gettext essentials
export TEXTDOMAIN=update-f123light
export TEXTDOMAINDIR=/usr/share/locale

. gettext.sh

set -e

# Import the standard F123Light functions
. /usr/lib/F123-includes/script_functions.sh

# Due to the nature of system updates, this script may ask for the user's password more than once.
# Try to minimize user fears with a friendly message.
msgbox "$(gettext "You are updating your system, which may ask you for your password more than once. Don't be alarmed; this is perfectly normal. Press the enter key to continue.")"

# Update all packages on the system. Start with ALARM provided packages and versioned AUR packages.
infobox "$(gettext "Updating system software...")"
sudo pacman -Syu --noconfirm >& /dev/null

infobox "$(gettext "Updating configuration and other files...")"

# Cleanup just in case there is a temporary file repository left behind from a previous update.
sudo rm -Rf /tmp/F123Light

# Clone the files-F123Light git repository.
git clone -q https://github.com/F123/files-F123Light.git /tmp/F123Light

 # Copy in the files. All files are to be copied for now, and then /etc/skel should be recopied to the user's $HOME.
# This will only copy to the $HOME of the user running this update script.
shopt -s dotglob
sudo cp -R /tmp/F123Light/files/* /
cp -R /etc/skel/* $HOME

# The temporary files downloaded from the F123Light git repository are no longer needed. Kill the clone.
sudo rm -Rf /tmp/F123Light

# Stolen from the build functions and adapted for a running system
# Set the language used by speech-dispatcher
# This will become unnecessary if speech-dispatcher starts handling locales properly.
case "${LANG::5}" in
    "en_US") ;&
    "pt_BR") sudo sed -i -e "s/^[#[:space:]]*DefaultLanguage [[:space:]]*\S*$/ DefaultLanguage   ${LANG//_/-}/" -e 's/\(.*Language\) \(.*\)\..*/\1\L\2/' "/etc/speech-dispatcher/speechd.conf" ;;
    *) sudo sed -i -e "s/^[#[:space:]]*DefaultLanguage [[:space:]]*\S*$/ DefaultLanguage   ${LANG::2}/" "/etc/speech-dispatcher/speechd.conf" ;;
esac
# Reload speech-dispatcher configuration
sudo pkill -1 speech-dispatch

# It seems that anything that runs after this point is executed as soon
# as it is pushed to the repository. We shouldn't need to make the user run this script twice.
# Test some newly pushed code
msgbox "This is a quick test. If you see this message, then we can push code to f123light any time after files-f123light is cloned and copied, and it will be executed automatically, even if your copy of /usr/bin/update-f123light was old. For example, if this worked, update-f123light should fix its own speech-dispatcher issues on its own, without the need to run it a second time. If you're seeing this, it should be fixed already."

# Prompt the user to reboot just in case something like the kernel that deserves a reboot has been updated.
# We will prompt for a keypress. Enter to reboot, escape to exit the script and return to the shell or calling script.
key=$(yesno "$(gettext "Your system has been updated. Although usually not necessary, it may help to reboot. Would you like to do this now? Press enter to reboot, or escape to finish the update without rebooting.")")
	case $key in
		"Yes")
			systemctl reboot
		;;
"No")
		;;
	esac
infobox "$(gettext "Update complete.")"
