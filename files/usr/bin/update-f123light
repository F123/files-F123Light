#!/bin/bash
#
# Copyright 2018, F123 Consulting, <information@f123.org>
# Copyright 2018, Kyle, <kyle@free2.ml>
#
# This is free software; you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free
# Software Foundation; either version 3, or (at your option) any later
# version.
#
# This software is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this package; see the file COPYING.  If not, write to the Free
# Software Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA
# 02110-1301, USA.
#
#--code--

# the gettext essentials
export TEXTDOMAIN=update-f123light
export TEXTDOMAINDIR=/usr/share/locale

. gettext.sh

set -e

# Import the standard F123Light functions
. /usr/lib/F123-includes/script_functions.sh

# Due to the nature of system updates, this script may ask for the user's password more than once.
# Try to minimize user fears with a friendly message.
msgbox "$(gettext "You are updating your system, which may ask you for your password more than once. Don't be alarmed; this is perfectly normal. Press the enter key to continue.")"

# Update all packages on the system. Start with ALARM provided packages and versioned AUR packages.
infobox "$(gettext "Updating system software...")"
sudo pacman -Syu --noconfirm >& /dev/null

infobox "$(gettext "Updating configuration and other files...")"

# Cleanup just in case there is a temporary file repository left behind from a previous update.
sudo rm -Rf /tmp/F123Light

# Clone the files-F123Light git repository.
git clone -q https://github.com/F123/files-F123Light.git /tmp/F123Light

 # Copy in the files. Only the files under files/usr should be copied
# to the system to avoid resetting configs modified by the system menu.
shopt -s dotglob
sudo cp -a /tmp/F123Light/files/usr/* /tmp/F123Light/files/boot/* /

# The temporary files downloaded from the F123Light git repository are no longer needed.
# Kill the clone.
sudo rm -Rf /tmp/F123Light

##### BEGIN INCREMENTAL UPDATE SECTION
##### Incremental updates may install or remove packages, manipulate system
##### configurations or even download other scripts.
##### Be careful with this section. It can break the systems of all F123Light users.
##### Still, it's better than resetting all configurations after every system update.
##### TODO: For each incremental update, perform the update only if its name is not in the list.
##### TODO: Add a function that will look for its parameter in the list file ... for readability.
##### Add incremental updates below this line


##### END INCREMENTAL UPDATE SECTION

# Prompt the user to reboot just in case something like the kernel that deserves a reboot has been updated.
# We will prompt for a keypress. Enter to reboot, escape to exit the script and return to the shell or calling script.
key=$(yesno "$(gettext "Your system has been updated. Although usually not necessary, it may help to reboot. Would you like to do this now? Press enter to reboot, or escape to finish the update without rebooting.")")
	case $key in
		"Yes")
			systemctl reboot
		;;
"No")
		;;
	esac
infobox "$(gettext "Update complete.")"
